---
layout: index
---


<div class="row">
    <div class="col-md-3 clear-padding-horizontal" id="navibar">
    </div>
    <div class="col-md-offset-1 col-md-8" id="listcontent">
        Content
    </div>
</div>

<script src="{{ '/js/load_all_postdata.js' | prepend: site.baseurl }}" type="text/javascript"></script>
<script src="{{ '/js/date_extend.js' | prepend: site.baseurl }}" type="text/javascript"></script>
<script type="text/javascript">
    var category_idx = {} ,
        date_idx ={} ,
        onewords_info = {} ,
        tag_idx = {} ,
        NAVI_TYPE_NAME = {'categoryTypeName':'Categories' , 'tagTypeName':'Tags'   };
    // INIT Data  
    var add_idx = function(set , item , post){
        if(!Array.isArray(item)) item = [item ,] ;
        for(var idx in item){
            var si = item[idx] ;
            if(set[si] == undefined){
                set[si] = [post,] ;
            }
            else {
                set[si].push(post) ;
            }
        }
    }
    for(var post_idx in post_data){
        var post = post_data[post_idx] ,
            categories = post.categories ,
            date_str = new Date(Date.parse(post['date'])).format('yyyy年MM月') , // Date.parse : 'May 30 , 2015' -> 1432915200000 ; New Date("14329...") 生成以该时间戳的时间对象 ， 调用extend里的format方法，构造成为该格式
            tags = post.tags ,
            onewords = post.onewords ;
        add_idx(category_idx , categories , post) ;
        add_idx(date_idx , date_str , post) ;
        add_idx(tag_idx , tags , post) ;
        onewords_info[onewords] = post.title ;
    }
    // DOM handler
    var navi = document.getElementById('navibar') ,
        list = document.getElementById('listcontent') ;
    
    var buildPostItem = function(post){
        var li_dom = document.createElement('LI') ,
            date_dom = document.createElement('SPAN') ,
            cont_dom = document.createElement('H3') ,
            excerpt_dom = document.createElement('P') ,
            link_dom = document.createElement('A') ;
        date_dom.setAttribute('class' , 'post-meta') ;
        date_dom.innerHTML = post.date ;
        
        link_dom.setAttribute('class' , 'post-link') ;
        link_dom.setAttribute('href' , post.url) ;
        link_dom.innerHTML = post.title ;

        excerpt_dom.setAttribute('class' , 'post-excerpt') ;
        excerpt_dom.innerHTML = post.excerpt || post.onewords ;
        
        cont_dom.appendChild(link_dom) ;
        li_dom.appendChild(date_dom) ;
        li_dom.appendChild(cont_dom) ;
        li_dom.appendChild(excerpt_dom) ;
        
        return li_dom ;
    }
    var buildTagDom = function(tag , freq){
        var tagDom = document.createElement('SPAN') ;
        var styles = ["label-default" , "label-primary" , "label-success" , "label-info" , "label-warning" , "label-danger"] ;
        var fonts = ["Microsoft YaHei" , "SimSun" , "Microsoft JhengHei" , "KaiTi_GB2312" , "YouYuan" , "STXingkai"] ;
        var fontSizes = [12,14,16,18,20,30] ;
        var fontWeights = [400,500,600,700] ;
        var marginHValue = [2,4,6] ;
        var marginVValue = [1,2,3] ;
        var tipWords = ["出现了" + freq + "次" , "找到了"+ freq+"次" , "一共有" + freq + "个" ] ;
        var getRandomItem = function(a){return a[Math.floor(Math.random()*a.length + 1) -1] + "" } ; 
        var random_style = getRandomItem(styles) ;
        var random_fontstyle = ["font:" , getRandomItem(fontWeights) , getRandomItem(fontSizes) + 'px', 
            getRandomItem(fonts)].join(' ') ;
        var margin_style = ["margin:" , getRandomItem(marginHValue) + "px" , getRandomItem(marginVValue)+ "px"].join(" ") ;
        var random_tips = getRandomItem(tipWords) ;
        
        tagDom.setAttribute("class" , ["label" , random_style].join(" ")) ;
        tagDom.setAttribute('style' , ["display: inline-block" , random_fontstyle , margin_style].join(";")) ;
        tagDom.setAttribute('title' , random_tips) ;
        tagDom.innerHTML = tag ;
        return tagDom ;
    }
    /* INIT DOM Elements , including post_dom , tags_dom , onewords_dom */
    /* We build all dom for every post , bind it to post_data */
    
    for(var idx in post_data){
        post_data[idx]["dom"] = buildPostItem(post_data[idx]) ;
    }
    
    var tagDoms = (function(tag_idx){
        var tagDom = [] ;
        for(var tag in tag_idx)  tagDom.push(buildTagDom(tag , tag_idx[tag].length)) ;
        return tagDom ;
        })(tag_idx)
    
    /* INIT navi bar*/
    
    var NAVI_INNER_STYLE = { 'list-active':["border-right:1px solid #3fa7cb" , 'margin-right:-1px' ] 
                            
                            };
    var RESPONSE_ACTIVE_EVENT_ELEMENTS = [] ;
    var CATEGORY_ELEMENTS = [] ;
    var CATEGORY_NAME_TO_ELEMENT = {} ;
    var TAG_NAME_TO_ELEMENT = {} ;
    var buildNaviList = function(naviTypeName , itemList , naviId ,name2ElementIdx){
        // input > itemList , is the idx like category_idx , tags_idx and so on
        var panel = document.createElement('DIV') ,
            navi = document.createElement('UL') ,
            header = document.createElement('DIV') ;
        panel.setAttribute('class' , 'panel panel-default clear-border clear-margin-horizontal') ;
        panel.setAttribute('id' , naviId ) ;
        
        header.setAttribute('class' , 'panel-heading ') ;
        header.innerHTML = naviTypeName ;
        
        navi.setAttribute('class' , 'list-group') ;
        
        for(var idx in itemList){
            var item = itemList[idx] ,
                link_dom = document.createElement('A') ,
                badge = document.createElement('SPAN');
            link_dom.setAttribute('class' , 'list-group-item') ;
            link_dom.setAttribute('href' , ['###',naviTypeName,idx].join('&')) ;
            link_dom.innerHTML = idx ;
            
            badge.setAttribute('class' , 'badge') ;
            badge.innerHTML = item.length ;
            
            link_dom.appendChild(badge) ;

            navi.appendChild(link_dom) ;
            /* build the name to node index*/
            name2ElementIdx[idx] = link_dom ;
        }

        panel.appendChild(header) ;
        panel.appendChild(navi) ;
        
        return panel ;
    }
    
    var buildNaviOnlyHeader = function(typeName , naviId , name2ElementIdx){
        var panel = document.createElement('DIV') ,
            header = document.createElement('DIV') ,
            link = document.createElement('A');
    
        panel.setAttribute('class' , 'panel panel-default clear-border clear-margin-horizontal') ;
        panel.setAttribute('id' , naviId) ;
        header.setAttribute('class' , 'panel-heading') ;
        
        link.setAttribute('href' , ["###",typeName].join('&')) ;
        link.innerHTML = typeName ;
        header.appendChild(link) ;
        panel.appendChild(header) ;
        name2ElementIdx[typeName] = link ;
    
        return panel ;
    }

    var categoryPanel = buildNaviList(NAVI_TYPE_NAME['categoryTypeName'] , category_idx ,  'category_panel' , CATEGORY_NAME_TO_ELEMENT) ;
    navi.appendChild(categoryPanel) ;
    
    /* build Tag */

    var tagPanel = buildNaviOnlyHeader(NAVI_TYPE_NAME['tagTypeName'] , 'tag_panel' , TAG_NAME_TO_ELEMENT) ;
    navi.appendChild(tagPanel) ;

    CATEGORY_ELEMENTS = categoryPanel.getElementsByTagName('A') ;
    TAG_ELEMENTS = tagPanel.getElementsByTagName('A') ;
    /* add the right elements to the RESPONSE_ACTIVE_EVENT_ELEMENTS */
    (function(RESPONSE_ACTIVE_EVENT_ELEMENTS){
        for(var i = 0 ; i < CATEGORY_ELEMENTS.length ; ++i) RESPONSE_ACTIVE_EVENT_ELEMENTS.push(CATEGORY_ELEMENTS[i]) ;
        for(var i = 0 ; i < TAG_ELEMENTS.length ; ++i) RESPONSE_ACTIVE_EVENT_ELEMENTS.push(TAG_ELEMENTS[i]) ;
        })(RESPONSE_ACTIVE_EVENT_ELEMENTS)

    // Event handler
    var helperGetTextValue = function(node){
        var text = [] ;
        for(var i = 0 ; i < node.childNodes.length ; ++i){
            var childNode = node.childNodes[i] ;
            if(childNode.nodeName == '#text' || childNode.nodeType === 3){
                text.push(childNode.nodeValue) ;
            }
        }
        return text.join(" ").trim() ;
    }
    var helperGetNode = function(nodeTextValue , cadidateDoms){
        // by  brute force
        for(var i = 0 ; i < cadidateDoms.length ; ++i){
            if(helperGetTextValue(cadidateDoms[i]) == nodeTextValue) return cadidateDoms[i] ;
        }
        return null ;
    }
    var setCategoryList = function(target){
        // input > target : DOM Element of category navi
        var target_val = helperGetTextValue(target) ;
        if(category_idx[target_val] == undefined) console.error("Error to find corresponding category date") ;
        else{
            // first , remove all the child of listContent
            while(list.childNodes.length){
                list.removeChild(list.lastChild) ;   
            };
            var ulDOM = document.createElement('ul')
            ulDOM.setAttribute('class' , 'post-list') ;
            
            list.appendChild(ulDOM) ;
            for(var i = 0 ; i < category_idx[target_val].length ; ++i){
                var post = category_idx[target_val][i] ;
                ulDOM.appendChild(post.dom) ;
            }
        }

    }
    var setTagList = function(){
        // usging Global Variable tag_idx
        while(list.childNodes.length){
            list.removeChild(list.lastChild) ;   
        };
        for(var idx in tagDoms) list.appendChild(tagDoms[idx]) ;
    }

    var setActiveFace = function(ele){
        ele.setAttribute('style' , NAVI_INNER_STYLE['list-active'].join(';') ) ; 
    }
    var removeActiveFace = function(ele){
        ele.removeAttribute('style') ;
    }
    var changeActiveState = function(selectedElement , candidateDoms){
        // first , check selected Element is the valid DOM | brute force
        var valid = false ;
        for(var i = 0 ; i < candidateDoms.length ; ++i) if(selectedElement == candidateDoms[i]){ valid = true ; break ;}
        if(!valid) return false ;

        // canvel origin selected
        for(var i = 0 ; i < candidateDoms.length ; ++i) removeActiveFace(candidateDoms[i]) ;
        
        setActiveFace(selectedElement) ;
    }
    
    var changeListContent = function(selectedType , selectedEle){
        if(selectedType == NAVI_TYPE_NAME['categoryTypeName']){
            setCategoryList(selectedEle) ;
        }
        if(selectedType == NAVI_TYPE_NAME['tagTypeName']) setTagList() ;
        changeActiveState(selectedEle , RESPONSE_ACTIVE_EVENT_ELEMENTS) ;
    }
    

    // bind Event
    categoryPanel.onclick = function(e){ 
        var target = e.target ;
        if(target.nodeName != 'A') return false ;
        setCategoryList(target) ;
        changeActiveState(target , RESPONSE_ACTIVE_EVENT_ELEMENTS) ;
    } ;
    tagPanel.onclick = function(e){
        var target = e.target ;
        if(target.nodeName != 'A') return false ;
        setTagList() ;
        changeActiveState(target , RESPONSE_ACTIVE_EVENT_ELEMENTS) ;
    }
    // ON LOAD
    window.onload = function(){
        // if we return from other page , the location href will store the previous info . we should restore it !
        var queryStr = location.href.match(/###(.*)/) == null ? "" : location.href.match(/###(.*)/)[1] , /* ['###queryStr' , 'queryStr'] */
            queryStrParts = queryStr.split('&').filter(function(item){return item != ""}) ,
            selectedEle , 
            selectedType ;
        if(queryStrParts.length == 0){
            var category_links = categoryPanel.getElementsByTagName('A') ;
            if(category_links.length != 0) selectedEle = category_links[0] ;
            else selectedEle = null ;
            selectedType = NAVI_TYPE_NAME['categoryTypeName'] ;
        }
        else if(queryStrParts.length >= 1){
            var queryType = queryStrParts[0] ;
            if(queryType == NAVI_TYPE_NAME['categoryTypeName']){
                var categoryLinks = categoryPanel.getElementsByTagName('A') ;
                if(queryStrParts.length == 1){
                    if(categoryLinks.length > 0) selectedEle = categoryLinks[0] ;
                    else selectedEle = null ;
                }
                else{
                    var categoryText = queryStrParts[1] ;
                    if(CATEGORY_NAME_TO_ELEMENT[categoryText] == undefined) selectedEle = null ;
                    else selectedEle = CATEGORY_NAME_TO_ELEMENT[categoryText] ;
                }
                selectedType = queryType ;
            }
            else if(queryType == NAVI_TYPE_NAME['tagTypeName']){
                selectedType = NAVI_TYPE_NAME['tagTypeName'] ;
            }
        }
        changeListContent(selectedType , selectedEle) ;
    }
</script>


