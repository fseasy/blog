---
layout: post
title: 相机与图像 | 视觉SLAM十四讲-ch5
date: 2022-03-24
categories: 技术 
tags: 视觉SLAM十四讲 SLAM 径向畸变 相机成像
---
> 本节讲了相机模型（针孔、畸变、双目、RGB-D）、图像在计算机中的表示及一些基础操作。

## 1. 术语表

| 中文名称 | 英文名称                                              |
| :------- | :---------------------------------------------------- |
| 针孔相机 | pinhole camera                                        |
| 齐次坐标 | homogeneous coordinates                               |
| 内参     | intrinsics                                            |
| 外参     | extrinsics                                            |
| 光轴     | optical axis                                          |
| 像素     | pixel                                                 |
| 畸变     | distortion/distort                                    |
| 径向畸变 | radial distortion                                     |
| 切向畸变 | tangential distortion                                 |
| 桶形畸变 | barrel distortion (i.e. negative radial distortion)   |
| 枕形畸变 | pincusion distortion (i.e. positive radial distotion) |
| 畸变校正 | undistort                                             |

opencv的资源：
1. python版校准： https://docs.opencv.org/3.4.17/dc/dbb/tutorial_py_calibration.html
3. 自带的棋盘照片： https://github.com/opencv/opencv/blob/4.x/samples/data/left07.jpg (left01-14都是) 

## 2. 相机模型

（数码）相机模型，描述了一个真实世界的物体变成图像（像素）的过程。一般地，这涉及到3个坐标系上的转换：

$$
    \rm 世界坐标系(P_w) \rightarrow 相机坐标系(P_c) \rightarrow 像素坐标系(p)
$$

其中相机坐标系，一般以相机光心为坐标原点，光心所在平面为x、y轴所在平面，z轴垂直此平面指向物体方向。 
书中介绍此坐标系下有几个关键的平面： 

- 真实成像平面：焦平面，即CCD所在的平面。Z轴坐标为负（物体经过光心成倒立像，物体在Z轴正半轴，则成像平面在负半轴）。

- 对称成像平面：真实成像平面关于光心的对称平面。Z轴坐标为正。这是把底片成像翻转为我们正常看到的物体方向。
  可以认为这是相机的默认操作——且因为与物体在同一个半轴，计算更加方便，故实际计算时，一般直接用此平面。

- 归一化成像平面： 物体世界坐标 $P_w$ 转换为相机坐标 $P_c$后，还保留有 Z 轴信息。
然而 $P_c$ 最终投影到底片（成像平面）时，没有了深度（Z轴）信息。为了在 $P_c \rightarrow p$ 过程中计算方便，
首先将 $P_c$ 按Z轴值缩放，即 $\rm P_c(X, Y, Z) \rightarrow P_{c}^{'}(X/Z, Y/Z, 1)$. 
此归一化后的点，所在平面Z轴坐标为1，称其为归一化成像平面。

总结下来，对称成像平面、归一化成像平面，都是为了计算方便而人为定义的平面。

### 2.1 针孔相机模型

知道了整个建模的框架后，我们要实际看下计算逻辑。相机模型中，最简单/经典的就是针孔相机模型，也即小孔成像。

下图粗略地可视化了整个过程：

<div align="center">
  <img src="/assets/posts/vslam/14-ch5/pinhole_camera_model.png" alt="pinhole camera model"
      width="450">
  <p>图1： 针孔相机模型</p>
</div>

> 这是参考 [opencv-calibration][opencv_cali] 中[针孔相机模型图][pinhole_model]，参考书上的符号/过程绘制的图。

具体过程如下：

1. 计算世界坐标系下的点 $P_w = (X_w, Y_w, Z_w)$ 变换到相机坐标系下的点 $P_c = (X_c, Y_c, Z_c)$
   
   点还是那个点，只是坐标系换了——这对应到一个旋转、平移变换（第三讲内容）。
   
   $$
    \rm P_c = RP_w + t \Rightarrow P_c = TP_w
   $$
   
   > $T$ 是变换矩阵 $\begin{bmatrix} \rm R & t \\\\ \mathbf{0}^T & 1 \end{bmatrix}$，
   $T P_w$ 中的 $P_w$ 实际是齐次坐标 $\begin{bmatrix} \rm P_w \\\\ 1 \end{bmatrix}$ 按书中规则的简写。  
   
   $T$ 是我们要求解的参数，也被称为`外参`.

2. 计算 $P_c = (X_c, Y_c, Z_c)$ 落在对称成像平面($Z = f$)上的点 $P_f = (X_f, Y_f, f)$ 【中间计算过程】
   
   $P_{f}$ 是用于后续计算的辅助点，表示 $P_c$ 经小孔成像后落在对称成像平面上的点（显然点是落在成像平面上的，这里按前所述，
   为方便计算直接用对称成像平面）。
   因为在同一个坐标系下，且针孔相机模型下光透过小孔沿直线传播，
   故 $P_f$ 就是点 $P_c$ 与对称成像平面的交点。

   因为 $P_f$ 和 $P_c$ 在一条直线上，故向量 $\vec{OP_f}$ 只需由 $\vec{OP_c}$ 经过简单的常量缩放即可得到。
   且此常量就是二者 $Z$ 轴坐标的比值, 即 $\frac{f}{Z_c}$. 由此，有

   $$P_f = \frac{f}{Z_c} P_c = \frac{f}{Z_c}\begin{bmatrix} X_c \\ Y_c \\ Z_c \end{bmatrix}$$ 
   
3. 计算 $P_f = (X_f, Y_f, f)$ 转换到像素平面的坐标 $p = (u, v)$
   
   $P_f \rightarrow p$ 是模拟量(光)到数值量（像素）过程。计算前需要了解的背景信息如下：

   a. $P_f$ 坐标的单位是 `mm` 等距离单位，而 $p$ 的单位是像素。前者转换到后者，需要采样和缩放。
      在数学上，就是要乘上一个单位类似 `pp/mm` 的缩放系数。我们常说的 PPI (Pixels Per Inch) 应该就属于这种缩放系数。
   
   b. 一般地，X轴和Y轴的缩放系数是不同的，这里分别记为 $\alpha$, $\beta$. 而 $P_f$ 的Z轴信息，在平面上直接丢掉了。

      > 为何缩放系数不同，[下面](#为什么转换到像素坐标系时x轴y轴缩放比例一般不同)有简单的猜测。


Cx,Cy是图像的主点，即过镜头轴心垂直于成像平面与图像平面的交点。对针孔摄像机来讲，这个点是投影中心在成像平面上的垂直投影，同时也是径向畸变的中心 。


### 2.2 （镜头）畸变

https://en.wikipedia.org/wiki/Distortion_(optics)#cite_note-brown-4

https://en.wikipedia.org/wiki/Optical_axis

Brown-Conrady 畸变模型

有一张解释径向畸变和切向畸变的图，
[12](https://xhy3054.github.io/camera-calibration-undistort/)
https://xhy3054.github.io/camera-calibration-undistort/

### 附： 畸变原理及其他

畸变是因为镜头本身带来的。spherical aberrations.

https://www.bilibili.com/video/av97893301/

#### 针孔相机

除了市面常见的基于镜头（Lens）的相机，还真的有针孔相机。
从[知乎问题-为什么相机普遍没有采用小孔成像原理？它的缺陷在哪儿？][zh1]
里的回答里，可以看到 [Coded Aperture Imaging][coded_ai] 这篇有意思的文章。
里面提到针孔相机的优势： 

1. 无限景深 (infinite depth of field)
2. 无色差 (don't suffer from chromatic aberration) 
3. 可为高能光源成像 (form images from X-ray/Gamma-ray)

但它显然的劣势就是透光亮小，无法应用到消费市场（想象一个固定小光圈的镜头，显然没人会买的），但在特定领域仍有价值。


#### CCD成像大致过程

CCD一般是一个矩形，内部由一个个像素单元按行、列排布构成。
TODO

#### 为什么转换到像素坐标系时，X轴、Y轴缩放比例一般不同？

网上没有找到确切的答案。总结+猜测有一下几个可能： 

1. 像素，本来就不是方形 [^1]
2. 像素在横、纵的排列间距不同 
3. 考虑生产过程整体最优解（如机器要求像素个数最好是某个数的倍数？类似于内存大小是8bit的倍数？）
3. 受生产工艺的影响，像素无法小到横纵个数比例刚好和物理比例一致 (基本不可能。从下面的例子可以看到，实际像素个数并非尝试去无限拟合物理比例)
4. 生产误差（基本不可能。这大概会引起畸变，但不会引起缩放不一致问题）  

在[相机标定原理介绍（一）][cali_intro1]中，有一个通过传感器参数计算横纵缩放的例子：
NiKon D700相机，传感器尺寸：36.0×23.9 mm，最大分辨率为4256×2832； 
则横向缩放比例 $\alpha = \frac{36.0}{4256} = 8.46e^{-3}$，纵向缩放比例 $\beta = \frac{23.9}{2832} = 8.44e^{-3}$.
这说明，在设计层面，横纵的缩放比例就不同。（PS： 传感器尺寸，就对应到物理长、宽。这个是我没想到的）

[^1]: [工业相机标定相关知识整理][industry_cali]: 一般情况下相机成像单元不是严格的矩形的，其在水平和垂直方向上的大小是不一致的，这就导致在X和Y方向上的缩放因子不一样，所以需要分别定义两个缩放因子。对针孔摄像机来讲，表示图像传感器上水平和垂直方向上相邻像素之间的距离；                      




#### 其他的分辨率

直观地，我们知道数码相机有分辨率的限制（因为CCD的像素限制），但意外的是，镜头、胶片也有分辨率的限制。

首先是镜头“分辨率”，[知乎-OMNI][lens_resolution]的描述看起来比较可信，内容大致如下：
镜头的分辨率主要体现在镜头解析力上，相机不可能做到无线解析能力。一是因为复杂的光学透镜组存在各种畸变（球差、慧差等等），二是当光线的波长和障碍物的尺寸相当的情况下，会发生物理学上所说的衍射现象，因此只要是镜头解析力总是有限的。
为了衡量各个镜头的差异当然就需要有些标准来度量镜头的解析能力，当然这个标准可以从很多方面来看，比如常用的线对（lp/mm），当然可以从频谱上来看，就是调制传输函数（MTF），还可以从物理光学上的瑞利判据进行解释。

然后是胶片“分辨率”，摘取[知乎-亦明][film_resolution]的回答：
胶片的成像最小单位是银盐晶体颗粒，尺度大约几个到几十个微米，微观上并不是无限细分的。银盐晶体在成像时还会形成团簇排列的二级结构，进一步降低了有效分辨率。实践中胶片成像之后还要经过显影-定影操作，和印放过程，有效分辨率和信噪比还要进一步打折。
经验估计，普通135胶片的有效分辨率大约相当于300-500万像素的数码照片；用最细颗粒的低感胶片，顶级的镜头，最精密的暗房流程，能得到相当于1000万像素，甚至接近2000万像素的水平。现代主流135全画幅数码相机的像素数已经超越了这个水平。


[zh1]: https://www.zhihu.com/question/26800674 "为什么相机普遍没有采用小孔成像原理？它的缺陷在哪儿？"
[coded_ai]: http://www.paulcarlisle.net/old/codedaperture.html "Coded Aperture Imaging"
[opencv_cali]: https://docs.opencv.org/3.4.17/d9/d0c/group__calib3d.html "Camera Calibration and 3D Reconstruction"
[pinhole_model]: https://docs.opencv.org/3.4.17/pinhole_camera_model.png
[industry_cali]: https://blog.csdn.net/dcrmg/article/details/52880508 "工业相机标定相关知识整理"
[lens_resolution]: https://www.zhihu.com/question/34587586/answer/65273636 "OMNI"
[film_resolution]: https://www.zhihu.com/question/34623286/answer/2448217660 "胶卷的像素是无限的吗？"
[cali_intro1]: https://www.cnblogs.com/Jessica-jie/p/6596450.html "相机标定原理介绍（一）"