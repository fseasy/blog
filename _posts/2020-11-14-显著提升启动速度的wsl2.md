---
layout: post
title: 显著提升启动速度的WSL2
date: 2020-11-14
categories: 技术 
tags: WSL
---
> 最近终于收到推送，更新了Win10 2020H2. 想起有点意思的 WSL2 应该已经可用了吧，于是尝试了下。发现了显著的启动速度提升，秒开！遂大概了解、试用一下，形成潦草的此文。


开篇废话一下：
在几年前的[文章]({% link _posts/2016-08-03-WslBashOnWindowsConfig.md %})中，我们介绍了WSL, 如何开启、如何自动后台启动、Xshell连入等。时过境迁，随着研究生毕业成了打工人、XShell收费，这篇文章里大费周章介绍的东西，也如过往一般失去了意义——话说，前不久才把“后台启动wsl”的自动任务给从Windows里删除了呢！（电脑用了9年了~）
前几年，Windows推出了 Windows Terminal, 虽然配置上相比XShell相去甚远，但是Terminal的基本功能却是有过之而无不及，所以XShell收费导致的Win终端缺失的问题，基本解决。剩下的，就是找找闲暇时间，折腾一下了。

因为现在兴趣渐减，很多东西没有严格考证，因此下面的内容很可能是错误的。

## WSL1 与 WSL2 的区别

WSL1, 现在也被叫做 WSL Legacy（多么熟悉的名字啊， 每次各种系统不兼容升级，总会看到这个名字）。它的内核是 Windows NT, 通过把 Linux 的内核调用拦截转换成NT内核调用，从而实现 Windows 上跑 Linux 。 它有很明显的缺陷：

1. 文件访问速度极其慢！ 可能是文件读取也需要转换？总之实际体验的时候，会明显感觉 IO 效率很低，特别是启动 WSL1 的时候，感觉要等 2s
2. 一些内核调用不支持，导致涉及底层的工具没法用：譬如，当时的 ping 都没法用，docker 等也不太行。

WSL2 , 就换了一套思路了（不知道是不是换了一拨人……）：很简单，翻译内核命令，真的是吃力不讨好，何不直接跑虚拟机呢~ （据说 Windows 本身就是跑在Hyper-V上 的虚拟机呢？ 从不知道哪里的知乎回答上看到的，真实待考）。 于是 WSL2 就走上了直接跑虚拟机的路子。

据 [Comparing WSL 1 and WSL 2](https://docs.microsoft.com/en-us/windows/wsl/compare-versions) ([中文版文档](https://docs.microsoft.com/zh-cn/windows/wsl/compare-versions))，
WSL2 用上了 latest & greatest 虚拟化技术，在一个轻量、通用( utility )的虚拟机上，跑起了 Linux Kernel! （所谓 Linux Kernel inside ?） 

这个 Linux Kernel 是 MS 从 `kernel.org` 上的内核源码的最新分支编译而来，且专门优化了大小和性能，以此来提供 Amazing Linux Experience on Windows. 特别地，内核的更新会通过 Windows 本身的更新附带 （需要打开 接收 Windows 相关产品更新），所以不必担心内核的安全等问题 —— 而且，你和可以在 WSL2 系统里，自己去更新内核——说明这个“优化”编译版本，和主 branch 的差异也不是那么大嘛。

传统的 VM 是需要很长的启动时间的，而且占用大量资源，还需要去自己配置，很麻烦。（这个是事实，自己得去下镜像、下VM，启动VM，安装系统，成本较高。）使用 WSL2 则不必如此 —— 开箱即用。只需要去应用商店，下载 Ubuntu 系统，装上，在终端里就可以跑起来了（第一次启动还是要等一会儿，然后它提示你创建账号、密码），像一个普通应用一般。 WSL2 的 VM 只使用少量的内存，而且这个内存还是给 WSL1 用的（The utility will allocate Virtual Address backed memory on startup. It is configured to start with a smaller proportion of your total memory that what was required for WSL 1. ？）

总之，WSL2 就是虚拟机，只不过是与系统高度集成、由 MS 维护的，免去了第三方安装、使用的繁琐、笨重。

相比 WSL1 优势：文件访问速度大幅提升（自我感知），Full Linux Kernel, Full system call compatibility, 所以，Git、Docker 可以顺畅跑了

相比 WSL1 劣势： 跨操作系统操作文件，性能降低； 因为是虚拟机，WSL2 的网络是独立于 host 的。

## WSL2 的文件系统

在 [compare-versions#expanding-the-size-of-your-wsl-2-virtual-hard-disk](https://docs.microsoft.com/en-us/windows/wsl/compare-versions#expanding-the-size-of-your-wsl-2-virtual-hard-disk)
中，可以发现——
WSL2 使用的是 ext4 格式的文件系统，通过 VHD 支持动态扩容，但最大为 256 GB ，超过后就得看上面的链接来调整了。

所以，快速的 “秘诀” 找到了，原来就是用了原生的文件系统。

现在，要在host上找到 linux 的文件系统，可以这样做： 

方法1： Win + Q, 然后输入 `\\wsl$` (或者直接在资源管理器里打这个地址也可)，就会弹出文件系统啦。 可以看到，它是通过网络进行挂载的。难怪 WSL2 跨系统操作文件，性能不如 WSL1 .

方法2： 在 WSL2 的系统（Linux）里，运行 `powershell.exe /c start .` , 然后就会在 Host 里打开 WSL2 的 home 目录。 总感觉有点意思 —— 两个系统互相调用！

那么在 WSL2 里如何访问 Host 的文件系统呢？ 看了一下，还是自动挂载到 `/mnt/` 下了，很棒。

## 支持 GPU

WSL2 已经可以支持 GPU 加速计算了~ 但是自己没试 （9年前的 GPU 已经不被 TF 支持了…… 不知道 PyTorch 支持不，有空试试）

具体见： [gpu-compute](https://docs.microsoft.com/en-us/windows/wsl/tutorials/gpu-compute) （[中文文档](https://docs.microsoft.com/zh-cn/windows/wsl/tutorials/gpu-compute)）

## 支持其他虚拟机

以前，开了 Hyper-V, 就没法用其他虚拟机了…… 不过，现在情况得到了改善。

可以见 [可以用第三方虚拟机吗？](https://docs.microsoft.com/en-us/windows/wsl/wsl2-faq#will-i-be-able-to-run-wsl-2-and-other-3rd-party-virtualization-tools-such-as-vmware-or-virtualbox) （
[中文](https://docs.microsoft.com/zh-cn/windows/wsl/wsl2-faq#will-i-be-able-to-run-wsl-2-and-other-3rd-party-virtualization-tools-such-as-vmware-or-virtualbox)）。

但经过实测，启用 WSL2 后， VirtualBox 6 启动虚拟机似乎有些问题，但根据 [Using Hyper-V with Oracle VM VirtualBox](https://docs.oracle.com/en/virtualization/virtualbox/6.0/admin/hyperv-support.html), 官方说是可以跑的。 暂时不太关注这个。

> VirtualBox 更新到 6.1, 跑原有的镜像不会报错了，但是只能到启动界面，再往后会 hang 住，没有再继续探索。 整体来看，基本
  开了 WSL2, 就暂时别想用其他虚拟机了。  
  我后面试了下，发现不启用 WSL2, 仅仅下载 `ubuntu20.04` 的镜像，在 WSL1 模式下，同样非常快。 或许单纯就启动速度而言，没有必要用 WSL2.

## 如何安装

见 [install-wsl & update to wsl2](https://docs.microsoft.com/en-us/windows/wsl/install-win10) ([中文文档](https://docs.microsoft.com/zh-cn/windows/wsl/install-win10))


## 最后

可以看到，本文就是翻译了点官网doc（而且后来发现都有中文版的文档orz），并没有太多的实际体验。 水一篇文章吧。